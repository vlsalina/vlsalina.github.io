<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

  svg {
    background-color: lightblue;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  #heading {
    position: absolute;
    top: 5%;
    left: 50%;
    transform: translate(-50%,0);
    text-align: center;
  }

  #title {
    color: blue;
  }

  #description {
    color: blue;
  }

  rect {
    fill: cadetblue;
    opacity: 0.3;
    stroke: white;
  }

  text {
    font-family: "Helvetica Neue", Helvetica, sans-serif;
    fill: white;
    font-size: 10px;
  }

</style>
</head>
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<script>

var margin = {"top": 50, "right": 50, "bottom": 50, "left": 50};
var width = 1780,
    height = 780;


var svg = d3.select("body").append("svg")
    .attr("transform", "translate(" + margin.left*10 + "," + margin.top*10 + ")")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

// heading to contain title and description
var heading = d3.select("body")
          .append("div")
          .attr("id", "heading");

// title element
var title = heading.append("h1")
          .attr("id", "title")
          .html("");

// description element
var description = heading.append("h3")
                  .attr("id", "description")
                  .html("");

// links
let links = d3.select("body")
            .append("div")
            .attr("id", "links");

// tooltip
let tooltip = d3.select("body")
                .append("div")
                .attr("id", "tooltip")
                .style("opacity", 0);


let kick_url = "https://vlsalina.github.io/kickstarter";
let movies_url = "https://vlsalina.github.io/movies";
let games_url = "https://vlsalina.github.io/games";

links.append("span")
      .append("a")
      .attr("id", "kickstarter")
      .attr("href", kick_url)
      .html("Kickstarter");

links.append("span").html(" | ");

links.append("span")
      .append("a")
      .attr("id", "movies")
      .attr("href", movies_url)
      .html("Movies");

links.append("span").html(" | ");

links.append("span")
      .append("a")
      .attr("id", "games")
      .attr("href", games_url)
      .html("Games");


let kickstarter = "https://cdn.freecodecamp.org/testable-projects-fcc/data/tree_map/kickstarter-funding-data.json";
let movies = "https://cdn.freecodecamp.org/testable-projects-fcc/data/tree_map/movie-data.json";
let games = "https://cdn.freecodecamp.org/testable-projects-fcc/data/tree_map/video-game-sales-data.json";

d3.queue()
  .defer(d3.json, kickstarter)
  .defer(d3.json, movies)
  .defer(d3.json, games)
  .await(ready);

function ready(error, kickstarter, movies, games) {
  console.log(kickstarter);
  console.log(movies);
  console.log(games);

  let curr = movies;


  // build treemap
  var treemapLayout = d3.treemap()
  .size([1880, 880])
  .paddingOuter(0);

  var rootNode = d3.hierarchy(curr)
  
  rootNode.sum(function(d) {
    return d.value;
  });
  
  treemapLayout(rootNode);  
  let rect_width = 0;
 
  var nodes = d3.select('svg')
  .selectAll('g')
  .data(rootNode.descendants())
  .enter()
  .append('g')
  .attr('transform', function(d) {return 'translate(' + [d.x0, d.y0] + ')'; })

  nodes
  .append('rect')
  .attr("id", function(d) { return d.data.name; })
  .attr('width', function(d) { return d.x1 - d.x0; })
  .attr('height', function(d) { return d.y1 - d.y0; });
  
  nodes
  .append('text')
  .text(function(d) {
    return d.data.name;
  })
  .attr("name", function(d) { return d.data.name; })
  .attr("data-width", function(d) { return d.x1 - d.x0; })
  .attr("x", 3)
  .attr("y", 10)
  .call(wrapText);

  
  // wrapper
  function wrapText(selection) {
    selection.each(function() {
      const node = d3.select(this);
      const rectWidth = +node.attr("data-width");
      const n = node.attr("name");
      let word;
      const words = node.text().split(" ").reverse();
      let line = [];
      const x = node.attr("x");
      const y = node.attr("y");
      let tspan = node.text(" ").append("tspan").attr("x", x).attr("y", y);
      let lineNumber = 0;
      while (words.length >= 1) {
        word = words.pop();
        line.push(word);
        tspan.text(line.join(" "));
        const tspanLength = tspan.node().getComputedTextLength();
        if (tspanLength > rectWidth) {
          //console.log(n + " More: " + tspanLength, rectWidth);
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = addTspan(word);
        } else {
          //console.log(n + " Less: " + tspanLength, rectWidth);  
        }

      }  

      addTspan(words.pop());

      function addTspan(text) {
          lineNumber += 1;
          return (
            node
              .append('tspan')
              .attr('x', x)
              .attr('y', y)
              .attr('dy', `${lineNumber * 10}px`)
              .text(text)
          );
      }

    })

  }

  // mouseover
  function onMouseMove(d,i) {      
     
    let str = "";
    let node = d3.select(this); 

    str = "Name: " + node.attr("id") + "<br>" +
          "Category: " + node.attr("category") + "<br>" +
          "Value: " + node.attr("value");

    let x = d3.event.pageX;
    let y = d3.event.pageY;

      tooltip.html(str)
            .style("opacity", 1)
            .style("background-color", "black")
            .style("color", "white")
            .style("padding", "20px")
            .style("position", "absolute")
            .style("left", (x+20) + "px")
            .style("top", y + "px")
            .style("border-radius", "10px");  
  }


} 

</script>
</body>
</html>
